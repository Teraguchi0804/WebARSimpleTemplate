!function(){"use strict";function t(){M.forEach(function(t){g[t]=Module[t]});for(var t in Module)t.match(/^AR/)&&(g[t]=Module[t])}function e(t,e,r){var i="/marker_"+p++;h(e,i,function(){var e=Module._addMarker(t,i);r&&r(e)})}function r(t){return String.fromCharCode.apply(String,t)}function i(t){var e=r(t),i=e.split("\n"),a=[],o=0,n=0;return i.forEach(function(t){if(t=t.trim(),t&&!t.startsWith("#"))switch(o){case 0:return n=+t,void(o=1);case 1:t.match(/^\d+$/)||a.push(t);case 2:case 3:case 4:return void o++;case 5:return void(o=1)}}),a}function a(t,e,r){var a="/multi_marker_"+f++;h(e,a,function(o){function n(){var e=Module._addMultiMarker(t,a),i=Module.getMultiMarkerNum(t,e);r&&r(e,i)}var s=i(o);if(!s.length)return n();var h=e.split("/").slice(0,-1).join("/");s=s.map(function(t){return"patt.hiro"===t||"patt.kanji"===t||"patt2.hiro"===t||"patt2.kanji"===t?["http://127.0.0.1:8080/data/data/"+t,t]:[h+"/"+t,t]}),d(s,n)})}function o(t,e){var r="/camera_param_"+m++,i=function(){var t=Module._loadCamera(r);e&&e(t)};"object"==typeof t?s(r,t,i):t.indexOf("\n")>-1?n(r,t,i):h(t,r,i)}function n(t,e,r){for(var i=new Uint8Array(e.length),a=0;a<i.length;a++)i[a]=255&e.charCodeAt(a);s(t,i,r)}function s(t,e,r){FS.writeFile(t,e,{encoding:"binary"}),r(e)}function h(t,e,r){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer",i.onload=function(t){var a=i.response,o=new Uint8Array(a);s(e,o,r)},i.send()}function d(t,e){var r=t.pop();r?h(r[0],r[1],function(){d(t,e)}):e()}var u=function(t,e,r){var i=t,a=e;if(this.orientation="landscape",this.listeners={},"number"!=typeof t){var o=t;r=e,i=o.videoWidth||o.width,a=o.videoHeight||o.height,this.image=o}if(this.defaultMarkerWidth=1,this.patternMarkers={},this.barcodeMarkers={},this.transform_mat=new Float32Array(16),this.canvas=document.createElement("canvas"),this.canvas.width=i,this.canvas.height=a,this.ctx=this.canvas.getContext("2d"),this.videoWidth=i,this.videoHeight=a,"string"==typeof r){var n=this;this.cameraParam=new c(r,function(){n._initialize()},function(t){})}else this.cameraParam=r,this._initialize()};u.prototype.dispose=function(){g.teardown(this.id);for(var t in this)this[t]=null},u.prototype.process=function(t){this.detectMarker(t);var e,r,i=this.getMarkerNum();for(e in this.patternMarkers)r=this.patternMarkers[e],r.inPrevious=r.inCurrent,r.inCurrent=!1;for(e in this.barcodeMarkers)r=this.barcodeMarkers[e],r.inPrevious=r.inCurrent,r.inCurrent=!1;for(var a=0;a<i;a++){var o=this.getMarker(a),n=g.UNKNOWN_MARKER,s=this.trackPatternMarkerId(-1);o.idPatt>-1&&(o.id===o.idPatt||o.idMatrix===-1)?(s=this.trackPatternMarkerId(o.idPatt),n=g.PATTERN_MARKER,o.dir!==o.dirPatt&&this.setMarkerInfoDir(a,o.dirPatt)):o.idMatrix>-1&&(s=this.trackBarcodeMarkerId(o.idMatrix),n=g.BARCODE_MARKER,o.dir!==o.dirMatrix&&this.setMarkerInfoDir(a,o.dirMatrix)),n!==g.UNKNOWN_MARKER&&s.inPrevious?this.getTransMatSquareCont(a,s.markerWidth,s.matrix,s.matrix):this.getTransMatSquare(a,s.markerWidth,s.matrix),s.inCurrent=!0,this.transMatToGLMat(s.matrix,this.transform_mat),this.dispatchEvent({name:"getMarker",target:this,data:{index:a,type:n,marker:o,matrix:this.transform_mat}})}for(var h=this.getMultiMarkerCount(),a=0;a<h;a++){var d=this.getMultiMarkerPatternCount(a),s=!1;g.getTransMatMultiSquareRobust(this.id,a),this.transMatToGLMat(this.marker_transform_mat,this.transform_mat);for(var u=0;u<d;u++){var c=this.getMultiEachMarker(a,u);if(c.visible>=0){s=!0,this.dispatchEvent({name:"getMultiMarker",target:this,data:{multiMarkerId:a,matrix:this.transform_mat}});break}}if(s)for(var u=0;u<d;u++){var c=this.getMultiEachMarker(a,u);this.transMatToGLMat(this.marker_transform_mat,this.transform_mat),this.dispatchEvent({name:"getMultiMarkerSub",target:this,data:{multiMarkerId:a,markerIndex:u,marker:c,matrix:this.transform_mat}})}}this._bwpointer&&this.debugDraw()},u.prototype.trackPatternMarkerId=function(t,e){var r=this.patternMarkers[t];return r||(this.patternMarkers[t]=r={inPrevious:!1,inCurrent:!1,matrix:new Float32Array(12),markerWidth:e||this.defaultMarkerWidth}),e&&(r.markerWidth=e),r},u.prototype.trackBarcodeMarkerId=function(t,e){var r=this.barcodeMarkers[t];return r||(this.barcodeMarkers[t]=r={inPrevious:!1,inCurrent:!1,matrix:new Float32Array(12),markerWidth:e||this.defaultMarkerWidth}),e&&(r.markerWidth=e),r},u.prototype.getMultiMarkerCount=function(){return g.getMultiMarkerCount(this.id)},u.prototype.getMultiMarkerPatternCount=function(t){return g.getMultiMarkerNum(this.id,t)},u.prototype.addEventListener=function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)},u.prototype.removeEventListener=function(t,e){if(this.listeners[t]){var r=this.listeners[t].indexOf(e);r>-1&&this.listeners[t].splice(r,1)}},u.prototype.dispatchEvent=function(t){var e=this.listeners[t.name];if(e)for(var r=0;r<e.length;r++)e[r].call(this,t)},u.prototype.debugSetup=function(){document.body.appendChild(this.canvas),this.setDebugMode(1),this._bwpointer=this.getProcessingImage()},u.prototype.loadMarker=function(t,e,r){return g.addMarker(this.id,t,e,r)},u.prototype.loadMultiMarker=function(t,e,r){return g.addMultiMarker(this.id,t,e,r)},u.prototype.getTransMatSquare=function(t,e,r){return g.getTransMatSquare(this.id,t,e),r.set(this.marker_transform_mat),r},u.prototype.getTransMatSquareCont=function(t,e,r,i){return this.marker_transform_mat.set(r),g.getTransMatSquareCont(this.id,t,e),i.set(this.marker_transform_mat),i},u.prototype.getTransMatMultiSquare=function(t,e){return g.getTransMatMultiSquare(this.id,t),e.set(this.marker_transform_mat),e},u.prototype.getTransMatMultiSquareRobust=function(t,e){return g.getTransMatMultiSquare(this.id,t),e.set(this.marker_transform_mat),e},u.prototype.transMatToGLMat=function(t,e,r){return e[0]=t[0],e[4]=t[1],e[8]=t[2],e[12]=t[3],e[1]=t[4],e[5]=t[5],e[9]=t[6],e[13]=t[7],e[2]=t[8],e[6]=t[9],e[10]=t[10],e[14]=t[11],e[3]=0,e[7]=0,e[11]=0,e[15]=1,void 0!=r&&0!==r&&(e[12]*=r,e[13]*=r,e[14]*=r),e},u.prototype.detectMarker=function(t){return this._copyImageToHeap(t)?g.detectMarker(this.id):-99},u.prototype.getMarkerNum=function(){return g.getMarkerNum(this.id)},u.prototype.getMarker=function(t){if(0===g.getMarker(this.id,t))return g.markerInfo},u.prototype.setMarkerInfoVertex=function(t,e){for(var r=0;r<e.length;r++)this.marker_transform_mat[2*r+0]=e[r][0],this.marker_transform_mat[2*r+1]=e[r][1];return g.setMarkerInfoVertex(this.id,t)},u.prototype.cloneMarkerInfo=function(t){return JSON.parse(JSON.stringify(t))},u.prototype.getMultiEachMarker=function(t,e){if(0===g.getMultiEachMarker(this.id,t,e))return g.multiEachMarkerInfo},u.prototype.getTransformationMatrix=function(){return this.transform_mat},u.prototype.getCameraMatrix=function(){return this.camera_mat},u.prototype.getMarkerTransformationMatrix=function(){return this.marker_transform_mat},u.prototype.setDebugMode=function(t){return g.setDebugMode(this.id,t)},u.prototype.getDebugMode=function(){return g.getDebugMode(this.id)},u.prototype.getProcessingImage=function(){return g.getProcessingImage(this.id)},u.prototype.setLogLevel=function(t){return g.setLogLevel(t)},u.prototype.getLogLevel=function(){return g.getLogLevel()},u.prototype.setMarkerInfoDir=function(t,e){return g.setMarkerInfoDir(this.id,t,e)},u.prototype.setProjectionNearPlane=function(t){return g.setProjectionNearPlane(this.id,t)},u.prototype.getProjectionNearPlane=function(){return g.getProjectionNearPlane(this.id)},u.prototype.setProjectionFarPlane=function(t){return g.setProjectionFarPlane(this.id,t)},u.prototype.getProjectionFarPlane=function(){return g.getProjectionFarPlane(this.id)},u.prototype.setThresholdMode=function(t){return g.setThresholdMode(this.id,t)},u.prototype.getThresholdMode=function(){return g.getThresholdMode(this.id)},u.prototype.setThreshold=function(t){return g.setThreshold(this.id,t)},u.prototype.getThreshold=function(){return g.getThreshold(this.id)},u.prototype.setPatternDetectionMode=function(t){return g.setPatternDetectionMode(this.id,t)},u.prototype.getPatternDetectionMode=function(){return g.getPatternDetectionMode(this.id)},u.prototype.setMatrixCodeType=function(t){return g.setMatrixCodeType(this.id,t)},u.prototype.getMatrixCodeType=function(){return g.getMatrixCodeType(this.id)},u.prototype.setLabelingMode=function(t){return g.setLabelingMode(this.id,t)},u.prototype.getLabelingMode=function(){return g.getLabelingMode(this.id)},u.prototype.setPattRatio=function(t){return g.setPattRatio(this.id,t)},u.prototype.getPattRatio=function(){return g.getPattRatio(this.id)},u.prototype.setImageProcMode=function(t){return g.setImageProcMode(this.id,t)},u.prototype.getImageProcMode=function(){return g.getImageProcMode(this.id)},u.prototype.debugDraw=function(){var t=new Uint8ClampedArray(Module.HEAPU8.buffer,this._bwpointer,this.framesize),e=new ImageData(t,this.canvas.width,this.canvas.height);this.ctx.putImageData(e,0,0);for(var r=this.getMarkerNum(),i=0;i<r;i++)this._debugMarker(this.getMarker(i))},u.prototype._initialize=function(){this.id=g.setup(this.canvas.width,this.canvas.height,this.cameraParam.id);var t=g.frameMalloc;this.framepointer=t.framepointer,this.framesize=t.framesize,this.dataHeap=new Uint8Array(Module.HEAPU8.buffer,this.framepointer,this.framesize),this.camera_mat=new Float64Array(Module.HEAPU8.buffer,t.camera,16),this.marker_transform_mat=new Float64Array(Module.HEAPU8.buffer,t.transform,12),this.setProjectionNearPlane(.1),this.setProjectionFarPlane(1e3);var e=this;setTimeout(function(){e.onload&&e.onload(),e.dispatchEvent({name:"load",target:e})},1)},u.prototype._copyImageToHeap=function(t){if(t||(t=this.image),"IMG"===t.nodeName&&t.width>t.height||"VIDEO"===t.nodeName&&t.videoWidth>t.videoHeight)this.ctx.drawImage(t,0,0,this.canvas.width,this.canvas.height);else{this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);var e=this.canvas.height/this.canvas.width,r=this.canvas.width*e,i=this.canvas.height*e,a=(this.canvas.width-i)/2;this.ctx.drawImage(t,a,0,i,r)}var o=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),n=o.data;return!!this.dataHeap&&(this.dataHeap.set(n),!0)},u.prototype._debugMarker=function(t){var e,r;e=t.vertex;var i=this.ctx;i.strokeStyle="red",i.beginPath(),i.moveTo(e[0][0],e[0][1]),i.lineTo(e[1][0],e[1][1]),i.stroke(),i.beginPath(),i.moveTo(e[2][0],e[2][1]),i.lineTo(e[3][0],e[3][1]),i.stroke(),i.strokeStyle="green",i.beginPath(),i.lineTo(e[1][0],e[1][1]),i.lineTo(e[2][0],e[2][1]),i.stroke(),i.beginPath(),i.moveTo(e[3][0],e[3][1]),i.lineTo(e[0][0],e[0][1]),i.stroke(),r=t.pos,i.beginPath(),i.arc(r[0],r[1],8,0,2*Math.PI),i.fillStyle="red",i.fill()},u.getUserMedia=function(t){var e=t.facingMode||"environment",r=t.onSuccess,i=t.onError||function(t){},a=document.createElement("video"),o=function(){0!==this.videoWidth&&r(a)},n=!1,s=["touchstart","touchend","touchmove","touchcancel","click","mousedown","mouseup","mousemove","keydown","keyup","keypress","scroll"],h=function(t){n&&(a.play(),a.paused||s.forEach(function(t){window.removeEventListener(t,h,!0)}))};s.forEach(function(t){window.addEventListener(t,h,!0)});var d=function(t){a.addEventListener("loadedmetadata",o,!1),a.src=window.URL.createObjectURL(t),n=!0,h()},u={},c={};t.width&&(c.width=t.width,"object"==typeof t.width?(t.width.max&&(u.maxWidth=t.width.max),t.width.min&&(u.minWidth=t.width.max)):u.maxWidth=t.width),t.height&&(c.height=t.height,"object"==typeof t.height?(t.height.max&&(u.maxHeight=t.height.max),t.height.min&&(u.minHeight=t.height.max)):u.maxHeight=t.height),c.facingMode=e,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var g={audio:!1,video:{mandatory:u}};return navigator.getUserMedia?navigator.getUserMedia(g,d,i):i("navigator.getUserMedia is not supported on your browser"),a},u.getUserMediaARController=function(t){var e={};for(var r in t)e[r]=t[r];var i=t.onSuccess,a=t.cameraParam;e.onSuccess=function(){new c(a,function(){var e=this,r=t.maxARVideoSize||Math.max(o.videoWidth,o.videoHeight),a=r/Math.max(o.videoWidth,o.videoHeight),n=a*o.videoWidth,s=a*o.videoHeight;if(o.videoWidth<o.videoHeight){var h=n;n=s,s=h}var d=new u(n,s,e);d.image=o,o.videoWidth<o.videoHeight?(d.orientation="portrait",d.videoWidth=o.videoHeight,d.videoHeight=o.videoWidth):(d.orientation="landscape",d.videoWidth=o.videoWidth,d.videoHeight=o.videoHeight),i(d,e)},function(t){})};var o=this.getUserMedia(e);return o};var c=function(t,e,r){this.id=-1,this._src="",this.complete=!1,this.onload=e,this.onerror=r,t&&this.load(t)};c.prototype.load=function(t){if(""!==this._src)throw"ARCameraParam: Trying to load camera parameters twice.";if(this._src=t,t){var e=this;g.loadCamera(t,function(t){e.id=t,e.complete=!0,e.onload()},function(t){e.onerror(t)})}},Object.defineProperty(c.prototype,"src",{set:function(t){this.load(t)},get:function(){return this._src}}),c.prototype.dispose=function(){this.id!==-1&&g.deleteCamera(this.id),this.id=-1,this._src="",this.complete=!1};var g={UNKNOWN_MARKER:-1,PATTERN_MARKER:0,BARCODE_MARKER:1,loadCamera:o,addMarker:e,addMultiMarker:a},M=["setup","teardown","setLogLevel","getLogLevel","setDebugMode","getDebugMode","getProcessingImage","setMarkerInfoDir","setMarkerInfoVertex","getTransMatSquare","getTransMatSquareCont","getTransMatMultiSquare","getTransMatMultiSquareRobust","getMultiMarkerNum","getMultiMarkerCount","detectMarker","getMarkerNum","getMarker","getMultiEachMarker","setProjectionNearPlane","getProjectionNearPlane","setProjectionFarPlane","getProjectionFarPlane","setThresholdMode","getThresholdMode","setThreshold","getThreshold","setPatternDetectionMode","getPatternDetectionMode","setMatrixCodeType","getMatrixCodeType","setLabelingMode","getLabelingMode","setPattRatio","getPattRatio","setImageProcMode","getImageProcMode"],p=0,f=0,m=0;window.artoolkit=g,window.ARController=u,window.ARCameraParam=c,window.Module?t():window.Module={onRuntimeInitialized:function(){t()}}}();